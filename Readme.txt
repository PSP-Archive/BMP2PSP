                                                               そとのひと 2005/05/24




hellopsp, SimpleTurn, RIN (1.0 ... 初期版) 等のソースを元に作成しています。
この場を借りて、各作者の方々にお礼申し上げます。 m(_ _)m


(お約束ですが、本ドキュメントの内容、ツール、ライブラリなど、全て無保証です)


====================================================================================
------------------------------------------------------------------------------------
[内容概略]

	BMP to PSP こんばーた
		ビットマップファイルから、hellopsp のソースについている bitmap.c 形式の
		画像データを作成するツールです。


	なんちゃって描画ルーチン＆使い方サンプル
		画像ファイルを表示する関数群です。拡大縮小、半透明、クリッピング機能等。
		文字列の拡大縮小機能もあります。遅い描画速度が特徴 orz


	Visual C++ 6 用環境
		PSP プログラム開発を Visaul C++ でやってみようライブラリです。

------------------------------------------------------------------------------------
====================================================================================






====================================================================================
------------------------------------------------------------------------------------
[BMP to PSP こんばーた] ver 1.2.2
------------------------------------------------------------------------------------
====================================================================================


hellopsp のソースをお持ちの方にはおなじみの bitmap.c のようなデータファイルを作成し
ます。ビットマップファイルをドラッグ＆ドロップすると、同じフォルダに .c を作成しま
す。Windows XP 上で動作します。




hellopsp の bitmap は

----------------------------------------------
// bitmap image for Hello World PSP

const unsigned short image_seclogo[]={
0x5881,0x54E6,0x54E6,0x54E6,0x54E6, ...
...
... ,0xA0FD,0xA0FD,0xA0FD,0xA0FD,0xA0FD,
};
----------------------------------------------

のように const unsigned short 型の配列になっていて、ピクセルデータが続いています。
1 ピクセルあたりのデータは RGB555 の 2 バイトです。

	ちなみに、ビットの並びは
	Windows では xRRR RRGG GGGB BBBB ですが
	PSP     では xBBB BBGG GGGR RRRR です。

データは左上から横方向に走査して折り返しています。BMP to PSP こんばーた は、上記の
形式をベースにしたファイルを作成します。


オプションとして、

	・const をつける (ON)
	・バイナリファイルも書き出す (OFF)
	・バイナリファイルはリトルエンディアンで書き出す (ON)
	・ファイル名と配列名の先頭に image_ をつける (ON)

がありますが、普通はそのままで大丈夫です。


・const をつける
	bitmap.c の配列が const unsigned short なので、あわせています。
	標準で ON です。


・バイナリファイルも書き出す
	hellopsp では画像ファイル (.c) を #include してソースに含めていますが、画像ファ
	イルが増えるとビルドに時間がかかったりしますし、実行ファイル EBOOT.PBP が大きく
	なりすぎて PSP のオンメモリ (32MB ?) にとって問題がでてきます。シーンに合わせて
	動的にファイルを読み込んでデータを入れ替えることが解決の手段となります。そのた
	めのバイナリファイル (.bin) を作成します。
	標準で OFF です。


・バイナリファイルはリトルエンディアンで書き出す
	PSP は Windows PC (というか x86 CPU) と同じように、リトルエンディアンモードで
	CPU を動作させているようです (たぶん)。よって、書き出すバイナリデータもリトル
	エンディアンを標準に設定しています。
	標準で ON です。


・ファイル名と配列名の先頭に image_ をつける
	bitmap.c の配列名が image_ で始まる形式を取っているので、あわせています。
	ON にすると、ファイル名に image_ をつけた名前で配列名とファイル名を作成します。
	例えば Sample.bmp を変換すると、ファイル名は image_Sample.c になり、配列名は
	image_Sample[] = { ... となります。なお、ファイル名に日本語などを使用した場合の
	チェックをしていないので、必ずファイル名は Ascii 形式にしてください。
	標準で ON です。


なお、設定したオプションは保存しないので注意してください。


変換できるビットマップファイルは、8/24/32bpp のファイルです。4bpp 以下や、16bpp の
物は使用できません。また、8bpp は無圧縮 (RLE とかじゃない、ベタ形式 = ようは普通の
形式) のもののみ対応しています (エラーチェックしていません)。


[24bpp の場合]
	24bpp のファイルは、RGB555 に変換して出力します。hellopsp の bitmap.c に相当し
	ます。


[32bpp の場合]
	32bpp のファイルは RGB555 に加え、A8(アルファ 8bpp) も出力します。.c では、
	RGB555 の

		image_Sample[] = {...};

	のデータの他に

		image_Sample_alpha[] = {...};

	を作成します。アルファも左上から横方向に走査したデータです。1 ピクセルあたり 1
	バイトです (const unsigned char)。バイナリでは、ファイルの先頭から RGB555 の
	データが書き出された後に、A8 のデータが続きます。
	なお 32bpp のデータは Adobe Photoshop 等で作成できます。


[8bpp の場合]
	8bpp のファイルは、RGB555 のパレットデータが最大 256 個並んだ後、1 ピクセルあた
	り 1 バイトのピクセルデータ (正確には、インデックス) が続きます。
	具体的には

		unsigned short bmp_Sample_palette[]={...};

	のデータと

		unsigned char bmp_Sample[]={...};

	があります。バイナリ出力した場合もこの順番です。


[透明色のこと]
	本ツールでは、透明色 (いわゆる、抜き色) の指定はしません。何色 (正確にはインデッ
	クス) を透明色に使う (あるいは使わない) かは、プログラマの管理にゆだねられます。
	また、8bpp のバイナリファイルを書き出した時、パレット数がいくつあるのかという情
	報も書き出しません。








====================================================================================
------------------------------------------------------------------------------------
[なんちゃって描画ルーチン]
------------------------------------------------------------------------------------
====================================================================================


描画関係の関数群を少し作ってみました。色んなソースがごっちゃになっているのでそのまま
使うのは難しいでしょうが、いくらかは有用なものがあるかと思います。
描画のみなので Sound やスレッドとかは一切ありません (最近のソースはまだ見ていないの
で、私の中では情報が古いままです)。

また、PSP の実機を持っていないので、どのくらいの速度で動作するのかが不明です。1 ドッ
トごとにかなりの演算を C 言語のみで行っているので、かなり遅いものと思われますってい
うか確実に遅いです (´･ω･`)


後述するようにクリッピングして描画領域を狭くする、pgBitBlt() 等ですむ描画はそちらを
使う、などの対策が必要です。


※ ちなみに、回転機能はありません
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


myproc.h, myproc.c にソースとかが入ってます。


上記の 『BMP to PSP こんばーた』 で作成したデータを使うことを主眼にしています。
主な特徴は

	・クリッピング
	・原点変更
	・上下左右反転
	・輝度、半透明、加算半透明
	・拡大縮小
	・遅い

です。


なお、pg.c にある mh_print() を拡張した

	void mh_printEx(int x,int y,char *str,int col, int mag256X, int mag256Y);

は mh_print() を拡張して mag 倍の文字列を表示できる関数ですが、上下左右反転、輝度、
半透明、加算半透明には対応していません (クリッピングと拡大縮小のみ対応です)。




サンプル main.c に基本的な使い方があるので、そちらを参考にしてください。


[基本フロー]

・初期化する
	本ライブラリを使う前に、必ず

		nDrawRoutineInit();

	を実行してください。


・画像データを用意する
	上記ツールなどで ビットマップ関連のデータを用意してある場合は

		#include "xxxx.c"

	などを追加します。バイナリデータを読み込むときはあらかじめ充分な大きさと、
	対応する型の配列を用意しておき

		loadBinaryFile(char *file, unsigned char *p, long size);

	などで画像をロードします。


・画像データを登録する
	本ライブラリでは画像データを『パターン』と『チップ』で管理しますが、読み込ん
	だデータをどう関連付けるかを指定します。

	本ライブラリでは

		 8bpp 画像				: Indexed パターン
		16bpp 画像				: RGB555 パターン
		16bpp + アルファの画像	: RGB555A8 パターン

	と呼びます。

		setPattern_Indexed(int num, unsigned short *data_palette, ...
		setPattern_RGB555(int num, unsigned short *data_data, ...
		setPattern_RGB555A8(int num, unsigned short *data_data, ...

	画像の種類によって関数を使い分けます。対応する関数と引数が微妙に異なるので注意
	してください。
	本関数はデータを管理しているだけで配列のデータをごっそりコピーしたりすることは
	ないので、処理時間はかかりません。Indexed パターンでは動的にパレットアドレスを
	変更する (もしくは、異なるパレットを使用するパターンを作成しておく) ことで色違
	いキャラを簡単に実現できます。
	なお、『パターン』とは 1 ファイルの画像データまるまるをさし、『チップ』はパ
	ターンを 横 x 縦 に分割した単位です。分割もこの関数で変更するので、動的にチップ
	サイズを変更できます。


・透明色を指定する
	Indexed パターンでは透明色を指定できます。デフォルトでは透明色は無効です。透明
	色もいつでも変更できます。


・クリップサイズを指定する
	現時点での我々の PSP プログラミングはハードウェア機能を使ってバリバリ描画、とい
	うわけにはいかないので、P/ECE や WonderWitch のように、VRAM に 1 ドットずつぷち
	ぷちと地道に描く必要があります。PSP の CPU は結構速いですが、カラーで画面も広い
	ので結局パワーが充分ではありません。そのため、描画領域を小さくして (迫力は低下
	しますが) 高速化を図るのも一つの手です。
	デフォルトでは画面全体を描画領域にしていますが、

		setScreenClip(int left, int top, int right, int bottom);

	で任意のサイズに設定します。なお、pg.c にある関数などはクリップは無効なので、
	場合によって使い分けてください。


・原点位置を変更する
	クリップした場合、画面の左上の領域を使うか、中央に持ってくるか、などの選択肢が
	ありますが、キャラクタの座標の管理などがややこしくなることがあります。

		setScreenOrigin(int left, int top);

	で原点を変更すれば、プログラム時には座標 (0, 0) をベースにすればよい (つまり、そ
	のまま) ので、管理が楽になります。


・描画する
	構造体 PSPDRAWSTRUCT dst に必要なパラメータを設定し、

		pgDraw(&dst)

	で描画します。
	描画方法として、上下左右反転、半透明、加算半透明、輝度、拡大縮小が選択できます。
	パラメータにアルファを指定する必要があったりするので、設定し忘れのないように注意
	してください。
	拡大縮小のパラメータは 256 が基準 (x1) です。つまり 512 = x2, 128 = x1/2, 384 =
	x1.5 のようになります。最小は 1, 最大は 131072 です。131072 = 256 * 512、つまり
	1 ドットが 512 倍されるので画面を覆いつくします。よってこれ以上でかくてもあんま
	し意味が無いだろうということでの制限です。どーしてももっとでかくする必要があるな
	らソースを見て制限を緩和してください。


・フリップする
	通常のアプリと同じように

		pgScreenFlipV();

	等を使って画面を最終更新します。



[補足]
前述の通り、1 ドットごとプチプチと演算をしてかつアセンブラを使わず C だけでやってる
ので、速度は大変遅いです。画面を覆いつくすほどの大きいキャラクタで大迫力、というこ
とでは速度面でムリです。




[サンプル]

Cygwin と PS2Dev がインストールされ、パスが正しく設定されていれば makefile を 
make すればビルドできます。
RGB555A8 パターンのアルファを使った効果や、Indexed パターンのパレットを変更すること
で色違いキャラクタを表示する、拡大文字列描画、等です。
START でたぶん終了します。







====================================================================================
------------------------------------------------------------------------------------
[Visual C++ 6 用環境]
------------------------------------------------------------------------------------
====================================================================================


『PSP のソースを Win32 アプリとして VC で開発＆ビルドし、充分検証ができたら make で
　PSP の ELF バイナリを作る』

というフローに一歩近づくための方法です。1 つのソースファイルから Windows でも PSP で
もコンパイルできるようにしようということです。もちろん VC で直接 ELF バイナリを作る
ということではありません。




上記サンプルには MFC フォルダがあり、その中に VC 用のソースが入っています。PSP の
ソースのフォルダには、一切特別なファイルはありません。

以降、PSP フォルダとは PSP 用のソースが展開されたフォルダ、MFC フォルダとは PSP
フォルダの直下にある MFC ソースのフォルダを意味します。



・MFC フォルダの SampleDlg.dsw を起動します。


・ソースの SampleDlgDlg.cpp を開きます。上から 40 行目あたりが

	//#define __USE_THREAD

となっていることを確認します。ここのコメントを外すとスレッドで動くのですが、
エラーで止まったりブレークポイントで止めた後、VC ごとフリーズすることがよくある
ので、通常の開発中は非スレッドで行ってください。最終的な完成品を得る時には
コメントを外してビルドします。RELEASE ビルドではスレッド ON になるようになっていま
す。

非スレッドで行うことの弊害は、イベントドリブンで動かさないのでウィンドウの移動や
メニュー、終了等、いわゆる Windows アプリとしてできて当然のことができません。よって
VC をクリックし Shift + F5 を押し、 [デバッグの中止] で止めてください。
VC ごとフリーズするのに比べたら、すぐ慣れます。

画面キャプチャを取る時はスレッドありにする必要がありますが、うっかりそのままフリー
ズして泣かないように、ビルド後に実行する前は一度 VC を終了させて状態を保存してから
VC を再起動した方が、次に困りません。


・MFC フォルダにある .cpp のうち、例えば pg.cpp は

==============================
	#include "stdafx.h"
	#include "../pg.c"
==============================

というシンプルなものです。PSP のソースをできるだけ修正せずにするというコンセプト
です。新たにファイルを追加する時は、PSP フォルダには .c を、MFC フォルダには
それをラップ (?) する .cpp を追加し、プロジェクトには .cpp を追加します。この
方法だと .c がすぐに開けませんが、例えば上の #include "../pg.c" の行で右クリック
して 『ドキュメント ../pg.c を開く』とすれば開きます。なお、.c を追加した時など
は、PSP フォルダの makefile の OBJS などにも追加するのを忘れないでください。


・どうしても PSP と Win32 で場合分けしないとダメなケースもあります。例えば、
pg.c の

	char *pgGetVramAddr(unsigned long x,unsigned long y)

関数は Win32 と PSPで分けてあります。VRAM アドレスがらみなのでこれはどうしようも
ありません。しかし #ifdef とかで分けておけば、PSP の make でも問題ありません。
逆に言うと、大きく変える必要のあったのはこの箇所だけです。しかし、キャストしなけれ
ばエラーになったり、あいまいさを解決するために ( ) でくくったりする必要がある箇所は
(結構) あります。が、一度直しておけばいいのでもりもりやりましょう。その場合でも場合
わけしてあります。


・できあがった EXE ファイルでのキー配列は、PSP Emulator 0.6 以降のものと同じにして
います。


・PSP のシステムコール関連を処理するのが PSPThread.cpp です。ThreadFuncPSP( ) の
中の xmain() の実行以降、PSP ソース側に動作が移ります。ソースによっては argv 等の
引数を取るものがあるので、別のソースを使うときは適時修正してください。システムコー
ル (例えば void pspDisplayWaitVblankStart() など) を Win32 でそれらしく実装していま
すが、未実装や適当実装があるので、お好みに応じて追加＆修正してください。
ちなみに VSNNC 待ちは単に 17msec ほどのサイクルで別スレッドを動かし、そのカウンタが
増えるのを待っているだけです。


・RIN には string.h, string.c がありますが、これは MFC とかぶってしまうので、Win32
ではロードしないなどの場合分けがしてあります。


・hellopsp, SimpleTurn, RIN のソースを元に構成していますが、それぞれに細かな差異が
あるので、このライブラリに突っ込んだらすぐビルドができる、ということはありません。
関数の宣言位置やヘッダーなど、ちょこちょこ異なるのでいくらかいじる必要があります。
が、修正すれば hellopsp, SimpleTurn, RIN (古いバージョン) ともに、このライブラリで
ビルドできます。新しいソースをゲットしても、未実装のシステムコールとかがなければ、
Win32 アプリとしてビルドできるでしょう。

(※ 現段階では描画関係ばっかりやっていたため、サウンド、コールバック、プロセス関係
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
が未実装ですので、最近の RIN などはビルドできません。もちろん、PSPThread.cpp に自
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
分で追加すれば可能です)
~~~~~~~~~~~~~~~~~~~~~~


・あくまでも最終的に PSP の ELF バイナリを作るのが目的なので、コードを書くときは
PSP 用のソース (.c) には Win32 API, MFC (CString, DWORD とか) などを使わないでくだ
さい (PSP 流に書いてください)。コツしては、DOS 窓を開いて PSP フォルダにパス変更
しておいて、時々 make してビルドできるか確認することです。
例えば

	for(int i=0; ...

は

	int i;
	for(i=0, ...

にしないと VC は OK ですが make で引っかかります。malloc() なども使えないようです。


・なにぶん PSP を持ってないので、実際の動作がどうなのかがわかりません。PSP 
Emulator では動作しているので、おかしなことはしてないと思います。
------------------------------------------------------------------------------------
